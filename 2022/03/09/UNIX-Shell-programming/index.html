

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/flag.jpg">
  <link rel="icon" href="/img/flag.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Otsutsuki-orance">
  <meta name="keywords" content="">
  
    <meta name="description" content="一个简单的shell编写在本项目中，我们编写了一个简单的壳程序，它只有执行命令，执行历史命令，使用管道，输出输入流定向等基本功能。但是它的编写却并不简单，我们现在来剖析一下。 一.总目标用户会输入一个字符串，我们的目标就是解析这个字符串（以空格划分）为命令和参数，存到一个二维char类型的数组args中，其中args[0]是命令，其余是参数。之后我们把它丢到 execvp函数里，这个函数长这样：">
<meta property="og:type" content="article">
<meta property="og:title" content="UNIX Shell programming">
<meta property="og:url" content="http://example.com/2022/03/09/UNIX-Shell-programming/index.html">
<meta property="og:site_name" content="愿岁并谢，与长友兮">
<meta property="og:description" content="一个简单的shell编写在本项目中，我们编写了一个简单的壳程序，它只有执行命令，执行历史命令，使用管道，输出输入流定向等基本功能。但是它的编写却并不简单，我们现在来剖析一下。 一.总目标用户会输入一个字符串，我们的目标就是解析这个字符串（以空格划分）为命令和参数，存到一个二维char类型的数组args中，其中args[0]是命令，其余是参数。之后我们把它丢到 execvp函数里，这个函数长这样：">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-03-09T13:52:34.000Z">
<meta property="article:modified_time" content="2022-03-09T14:30:56.875Z">
<meta property="article:author" content="Otsutsuki-orance">
<meta property="article:tag" content="操作系统">
<meta name="twitter:card" content="summary_large_image">
  
  
  <title>UNIX Shell programming - 愿岁并谢，与长友兮</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>万里蹀躞，以此为归</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="UNIX Shell programming">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-03-09 21:52" pubdate>
        March 9, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      9.8k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      82 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">UNIX Shell programming</h1>
            
            <div class="markdown-body">
              <h1 id="一个简单的shell编写"><a href="#一个简单的shell编写" class="headerlink" title="一个简单的shell编写"></a>一个简单的shell编写</h1><p>在本项目中，我们编写了一个简单的壳程序，它只有执行命令，执行历史命令，使用管道，输出输入流定向等基本功能。但是它的编写却并不简单，我们现在来剖析一下。</p>
<h2 id="一-总目标"><a href="#一-总目标" class="headerlink" title="一.总目标"></a>一.总目标</h2><p>用户会输入一个字符串，我们的目标就是解析这个字符串（以空格划分）为<strong>命令</strong>和<strong>参数</strong>，存到一个二维char类型的数组args中，其中args[0]是命令，其余是参数。<br>之后我们把它丢到 execvp函数里，这个函数长这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs C">execvp(args[<span class="hljs-number">0</span>],args);<br></code></pre></td></tr></table></figure>

<p>然后我们的操作系统就会自动调用这个接口来搞事情了。<br>但是在这之中我们还需要处理其他特殊情况：比如<em>有没有管道符号|，命令是否是!!，有没有重定向？有没有允许并发的&amp;&amp;符号？</em></p>
<h2 id="二-分步实现"><a href="#二-分步实现" class="headerlink" title="二.分步实现"></a>二.分步实现</h2><h4 id="1-输入"><a href="#1-输入" class="headerlink" title="1.输入"></a>1.输入</h4><p>首先我们要解决输入的解码问题。我们自己写了一个decode函数解码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">decode</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *command, <span class="hljs-keyword">char</span> **args)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= MAX_LINE / <span class="hljs-number">2</span> + <span class="hljs-number">1</span>; i++)<br>        args[i] = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">int</span> cutIndex = <span class="hljs-number">0</span>, order_index = <span class="hljs-number">0</span>, inner_index = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">char</span> ch = command[cutIndex];<br>    <span class="hljs-keyword">while</span> (ch != <span class="hljs-string">&#x27;\n&#x27;</span> &amp;&amp; ch != <span class="hljs-string">&#x27;\0&#x27;</span> &amp;&amp; ch != EOF) &#123;<br>        <span class="hljs-built_in">free</span>(args[order_index]);<br>        args[order_index] = (<span class="hljs-keyword">char</span> *) <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>) * MAX_LINE);<br>        <span class="hljs-built_in">memset</span>(args[order_index], <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(args[order_index]));<br>        <span class="hljs-comment">//for each block</span><br>        inner_index = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (ch != <span class="hljs-string">&#x27; &#x27;</span> &amp;&amp; ch != <span class="hljs-string">&#x27;\n&#x27;</span> &amp;&amp; ch != <span class="hljs-string">&#x27;\0&#x27;</span> &amp;&amp; ch != EOF) &#123;<br>            args[order_index][inner_index] = ch;<br>            ++cutIndex;<br>            ++inner_index;<br>            ch = command[cutIndex];<br>        &#125;<br>        <span class="hljs-comment">//写入&#x27;\0&#x27;</span><br>        args[order_index][inner_index] = <span class="hljs-string">&#x27;\0&#x27;</span>;<span class="hljs-comment">//我就是个智障，这个地方花了至少4h</span><br>        <span class="hljs-comment">//now comes the kongge</span><br>        <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">&#x27; &#x27;</span>) &#123;<br>            inner_index = <span class="hljs-number">0</span>;<br>            ++order_index;<br>            <span class="hljs-keyword">while</span> (ch == <span class="hljs-string">&#x27; &#x27;</span>) &#123;<br>                ++cutIndex;<br>                ch = command[cutIndex];<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现很繁，但是并不难，用malloc分配空间后**一定要注意在后面补’\0’**，血的教训。你会注意到C其实很蠢，什么基本功能都要自己实现，试想如果你有python的split()函数……</p>
<h4 id="2-历史记录查询"><a href="#2-历史记录查询" class="headerlink" title="2.历史记录查询"></a>2.历史记录查询</h4><p>当用户输入!!时，我们要从历史的记录中寻找，如果历史没有，那么报错。history就是一个存历史命令的二维数组。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">add_to_hist</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *command, <span class="hljs-keyword">char</span> *history[])</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; HIST_SIZE; i++) &#123;<br>        <span class="hljs-keyword">if</span> (history[i] == <span class="hljs-literal">NULL</span>) &#123;<span class="hljs-comment">//找到一个空的</span><br>            history[i] = (<span class="hljs-keyword">char</span> *) <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>) * MAX_LINE);<br>            <span class="hljs-built_in">strcpy</span>(history[i], command);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">free</span>(history[<span class="hljs-number">0</span>]);<br>    history[<span class="hljs-number">0</span>] = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; HIST_SIZE; i++) &#123;<br>        history[i - <span class="hljs-number">1</span>] = history[i];<br>    &#125;<br>    history[HIST_SIZE] = command;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>还是想吐槽C，连个队列都没有，我自己又懒得打一个，只能这样傻乎乎的实现了。</p>
<h4 id="3-管道实现"><a href="#3-管道实现" class="headerlink" title="3.管道实现"></a>3.管道实现</h4><p>关键来了，注意看<br>如何处理管道问题呢？我们会先写一个函数找出管道符号|的位置，在我这叫get_pipe_pos()，这个函数如果没有管道符号时会返回-1。这个时候的处理流程是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C">&#123;<br>            <span class="hljs-keyword">pid_t</span> pid;<br>			pid = fork();<br>			<span class="hljs-keyword">if</span>(pid==<span class="hljs-number">0</span>)<span class="hljs-comment">//child process</span><br>			&#123;<br>			   should_run=<span class="hljs-number">0</span>;<br>               output_redirect(args);<br>			   input_redirect(args);<br>               execvp(args[<span class="hljs-number">0</span>],args);<br><br>			&#125;<br>			<span class="hljs-keyword">else</span><span class="hljs-comment">//parent process</span><br>			&#123;<br>              <span class="hljs-keyword">if</span>(!will_wait)<br>			  &#123;<br>		        wait(<span class="hljs-literal">NULL</span>);<br>			  &#125;<br>			  will_wait=<span class="hljs-number">0</span>;<br>			&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>直接开到子进程里面去，同时父进程看是不是要根据&amp;&amp;来执行等待。引用恐龙书的话，就是：</p>
<blockquote>
<p><strong>II. Executing Command in a Child Process</strong></p>
<p>The first task is to modify the main() function in Figure 3.36 so that a child process is forked and executes the command specified by the user. This will require parsing what the user has entered into separate tokens and storing the tokens in an array of character strings (args in Figure 3.36). For example, if the user enters the command ps -ael at the osh&gt; prompt, the values stored in the args array are:<br> args[0] = “ps”<br>args[1] = “-ael”<br>args[2] = NULL<br>This args array will be passed to the execvp() function, which has the<br>following prototype:</p>
<p>execvp(char *command, char *params[])</p>
<p>Here, command represents the command to be performed and params stores the<br>parameters to this command. For this project, the execvp() function should<br>be invoked as execvp(args[0], args). Be sure to check whether the user included &amp; to determine whether or not the parent process is to wait for the child to exit.</p>
</blockquote>
<p>有管道呢？</p>
<p>我们的策略是再开一个子进程让他们在管道中通信，其中平凡实现略，比较值得一提的是dup2()函数，它将现有的文件描述符复制到另一个文件描述符。这个函数在处理重定向的时候也会用到，官方解释：</p>
<blockquote>
<p> This child will also create another child process (which will execute less) and will establish a pipe between itself and the child process it creates. Implementing pipe functionality will also require using the dup2() function .</p>
</blockquote>
<p>代码比较长，一并附于文末。</p>
<h4 id="4-数据流重定向"><a href="#4-数据流重定向" class="headerlink" title="4.数据流重定向"></a>4.数据流重定向</h4><p>其实这个也用到了dup2()函数，其实就是把输出的对象改到了一个文件中，并且把输入的对象改为了一个文件而已：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//这是输入流定向</span><br><span class="hljs-keyword">char</span> filename[<span class="hljs-number">10</span>];<br><span class="hljs-built_in">strcpy</span>(filename,args[i+<span class="hljs-number">1</span>]);<span class="hljs-comment">//之前得到具体参数的位置并存到filename</span><br><span class="hljs-keyword">int</span> fd = open(filename,O_RDWR|O_NOCTTY|O_NDELAY);<span class="hljs-comment">//Linux系统的打开管道其实就是读文件</span><br><span class="hljs-built_in">free</span>(args[i]);<span class="hljs-comment">//释放&#x27;&lt;&#x27;的那一块</span><br>args[i]=<span class="hljs-literal">NULL</span>;<br><span class="hljs-built_in">free</span>(args[i+<span class="hljs-number">1</span>]);<br>args[i+<span class="hljs-number">1</span>]=<span class="hljs-literal">NULL</span>;<br>dup2(fd,STDIN_FILENO);<span class="hljs-comment">//将文件作为输入</span><br><span class="hljs-keyword">char</span> *order_from_file;<br>order_from_file=(<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>)*MAX_LINE);<br>						fgets(order_from_file,MAX_LINE,<span class="hljs-built_in">stdin</span>);<span class="hljs-comment">//输入到这个字符串再解码</span><br>decode(order_from_file,args+i);<br><br><span class="hljs-built_in">free</span>(order_from_file);<br>close(fd);<br></code></pre></td></tr></table></figure>

<p>再来看看输出流定向：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">char</span> filename[<span class="hljs-number">10</span>];<br><span class="hljs-built_in">strcpy</span>(filename,args[i+<span class="hljs-number">1</span>]);<span class="hljs-comment">//获取文件名</span><br><br><span class="hljs-keyword">int</span> fd = open(filename,O_RDWR|O_NOCTTY|O_NDELAY);<br>dup2(fd,STDOUT_FILENO);<span class="hljs-comment">//跟之前的STDIN不同，这里作为输出了。</span><br>close(fd);<br><span class="hljs-built_in">free</span>(args[i]);<br>args[i]=<span class="hljs-literal">NULL</span>;<br><span class="hljs-built_in">free</span>(args[i+<span class="hljs-number">1</span>]);<br>args[i+<span class="hljs-number">1</span>]=<span class="hljs-literal">NULL</span>;<span class="hljs-comment">//一定要清理空间啊</span><br></code></pre></td></tr></table></figure>

<h2 id="三-完整代码"><a href="#三-完整代码" class="headerlink" title="三.完整代码"></a>三.完整代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_LINE 80</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HIST_SIZE 10</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">decode</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *command, <span class="hljs-keyword">char</span> **args)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= MAX_LINE / <span class="hljs-number">2</span> + <span class="hljs-number">1</span>; i++)<br>        args[i] = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">int</span> cutIndex = <span class="hljs-number">0</span>, order_index = <span class="hljs-number">0</span>, inner_index = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">char</span> ch = command[cutIndex];<br>    <span class="hljs-keyword">while</span> (ch != <span class="hljs-string">&#x27;\n&#x27;</span> &amp;&amp; ch != <span class="hljs-string">&#x27;\0&#x27;</span> &amp;&amp; ch != EOF) &#123;<br>        <span class="hljs-built_in">free</span>(args[order_index]);<br>        args[order_index] = (<span class="hljs-keyword">char</span> *) <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>) * MAX_LINE);<br>        <span class="hljs-built_in">memset</span>(args[order_index], <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(args[order_index]));<br>        <span class="hljs-comment">//for each block</span><br>        inner_index = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (ch != <span class="hljs-string">&#x27; &#x27;</span> &amp;&amp; ch != <span class="hljs-string">&#x27;\n&#x27;</span> &amp;&amp; ch != <span class="hljs-string">&#x27;\0&#x27;</span> &amp;&amp; ch != EOF) &#123;<br>            args[order_index][inner_index] = ch;<br>            ++cutIndex;<br>            ++inner_index;<br>            ch = command[cutIndex];<br>        &#125;<br>        <span class="hljs-comment">//写入&#x27;\0&#x27;</span><br>        args[order_index][inner_index] = <span class="hljs-string">&#x27;\0&#x27;</span>;<span class="hljs-comment">//我就是个智障，这个地方花了至少4h</span><br>        <span class="hljs-comment">//now comes the kongge</span><br>        <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">&#x27; &#x27;</span>) &#123;<br>            inner_index = <span class="hljs-number">0</span>;<br>            ++order_index;<br>            <span class="hljs-keyword">while</span> (ch == <span class="hljs-string">&#x27; &#x27;</span>) &#123;<br>                ++cutIndex;<br>                ch = command[cutIndex];<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">add_to_hist</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *command, <span class="hljs-keyword">char</span> *history[])</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; HIST_SIZE; i++) &#123;<br>        <span class="hljs-keyword">if</span> (history[i] == <span class="hljs-literal">NULL</span>) &#123;<span class="hljs-comment">//找到一个空的</span><br>            history[i] = (<span class="hljs-keyword">char</span> *) <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>) * MAX_LINE);<br>            <span class="hljs-built_in">strcpy</span>(history[i], command);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">free</span>(history[<span class="hljs-number">0</span>]);<br>    history[<span class="hljs-number">0</span>] = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; HIST_SIZE; i++) &#123;<br>        history[i - <span class="hljs-number">1</span>] = history[i];<br>    &#125;<br>    history[HIST_SIZE] = command;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">char</span> *<span class="hljs-title">find_history</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **history)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = HIST_SIZE - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; --i) &#123;<br>        <span class="hljs-keyword">if</span> (history[i] != <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">return</span> history[i];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">get_pipe_pos</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **args)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; args[i] != <span class="hljs-literal">NULL</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(args[i], <span class="hljs-string">&quot;|&quot;</span>))<span class="hljs-comment">//找到一个管道</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> i;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//没找到</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">output_redirect</span><span class="hljs-params">(<span class="hljs-keyword">char</span>**args)</span></span><br><span class="hljs-function"></span>&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;MAX_LINE/<span class="hljs-number">2</span>+<span class="hljs-number">1</span>&amp;&amp;args[i]!=<span class="hljs-literal">NULL</span>;i++)<br>		&#123;<br>				<span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(args[i],<span class="hljs-string">&quot;&gt;&quot;</span>))<span class="hljs-comment">//&gt;exists</span><br>				&#123;<br>						<span class="hljs-keyword">char</span> filename[<span class="hljs-number">10</span>];<br>						<span class="hljs-built_in">strcpy</span>(filename,args[i+<span class="hljs-number">1</span>]);<br><br>				       <span class="hljs-keyword">int</span> fd = open(filename,O_RDWR|O_NOCTTY|O_NDELAY);<br>						dup2(fd,STDOUT_FILENO);<br>                        close(fd);<br>						<span class="hljs-built_in">free</span>(args[i]);<br>					   args[i]=<span class="hljs-literal">NULL</span>;<br>					   <span class="hljs-built_in">free</span>(args[i+<span class="hljs-number">1</span>]);<br>					   args[i+<span class="hljs-number">1</span>]=<span class="hljs-literal">NULL</span>;<br>				&#125;<br>		&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">input_redirect</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **args)</span></span><br><span class="hljs-function"></span>&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;MAX_LINE/<span class="hljs-number">2</span>+<span class="hljs-number">1</span>&amp;&amp;args[i]!=<span class="hljs-literal">NULL</span>;i++)<br>		&#123;<br>				<span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(args[i],<span class="hljs-string">&quot;&lt;&quot;</span>))<br>				&#123;<br>						<span class="hljs-keyword">char</span> filename[<span class="hljs-number">10</span>];<br>						<span class="hljs-built_in">strcpy</span>(filename,args[i+<span class="hljs-number">1</span>]);<br><br>						<span class="hljs-keyword">int</span> fd = open(filename,O_RDWR|O_NOCTTY|O_NDELAY);<br>						<span class="hljs-built_in">free</span>(args[i]);<br>						args[i]=<span class="hljs-literal">NULL</span>;<br>						<span class="hljs-built_in">free</span>(args[i+<span class="hljs-number">1</span>]);<br>						args[i+<span class="hljs-number">1</span>]=<span class="hljs-literal">NULL</span>;<br>						dup2(fd,STDIN_FILENO);<br>						<span class="hljs-keyword">char</span> *order_from_file;<br>					   	order_from_file=(<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>)*MAX_LINE);<br>						fgets(order_from_file,MAX_LINE,<span class="hljs-built_in">stdin</span>);<br>						decode(order_from_file,args+i);<br><br>						<span class="hljs-built_in">free</span>(order_from_file);<br>						close(fd);<br>				&#125;<br><br>		&#125;<br>&#125;<br><span class="hljs-keyword">int</span> will_wait = <span class="hljs-number">0</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">char</span> *args[MAX_LINE / <span class="hljs-number">2</span> + <span class="hljs-number">1</span>];    <span class="hljs-comment">/* command line (of 80) has max of 40 arguments */</span><br>    <span class="hljs-keyword">char</span> *history[HIST_SIZE];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; HIST_SIZE; i++)history[i] = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">int</span> should_run = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">while</span> (should_run) &#123;<br>        will_wait = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;@_@&gt;&quot;</span>);<br>        fflush(<span class="hljs-built_in">stdout</span>);<br>        <span class="hljs-comment">//read the order as a string</span><br>        <span class="hljs-keyword">char</span> *cutorder;<br>        cutorder = (<span class="hljs-keyword">char</span> *) <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>) * MAX_LINE);<br>        fgets(cutorder, MAX_LINE, <span class="hljs-built_in">stdin</span>);<br>        <span class="hljs-comment">//处理！！的情况</span><br>        <span class="hljs-keyword">if</span> (cutorder[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;!&#x27;</span> &amp;&amp; cutorder[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;!&#x27;</span>)<span class="hljs-comment">//!!</span><br>        &#123;<br>            <span class="hljs-built_in">free</span>(cutorder);<br>            cutorder = find_history(history);<br>            <span class="hljs-keyword">if</span> (cutorder == <span class="hljs-literal">NULL</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;No command in history! What the hell are you doing?\n &quot;</span>);<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-comment">//not !!</span><br>            add_to_hist(cutorder, history);<br>        <span class="hljs-comment">//decode the order</span><br>        decode(cutorder, args);<br>        <span class="hljs-built_in">free</span>(cutorder);<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">          * After reading user input, the steps are:</span><br><span class="hljs-comment">          * (1) fork a child process</span><br><span class="hljs-comment">          * (2) the child process will invoke execvp()</span><br><span class="hljs-comment">          * (3) if command includes &amp;, parent and child will run concurrently</span><br><span class="hljs-comment">          */</span><br>        <span class="hljs-comment">//dealing with exit</span><br>        <span class="hljs-keyword">if</span> (args[<span class="hljs-number">0</span>] &amp;&amp; !<span class="hljs-built_in">strcmp</span>(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;exit&quot;</span>)) &#123;<br>            should_run = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">//now we have a complete args</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; args[i] != <span class="hljs-literal">NULL</span>; i++) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(args[i], <span class="hljs-string">&quot;&amp;&amp;&quot;</span>) == <span class="hljs-number">0</span> &amp;&amp; args[i + <span class="hljs-number">1</span>] == <span class="hljs-literal">NULL</span>)<span class="hljs-comment">//with &amp;&amp; at the end</span><br>            &#123;<br>                will_wait = <span class="hljs-number">1</span>;<br>                <span class="hljs-built_in">free</span>(args[i]);<br>                args[i] = <span class="hljs-literal">NULL</span>;<br>            &#125;<br>        &#125;<br>    <span class="hljs-comment">//dealing with pipes</span><br>    <span class="hljs-comment">//管道的一般用法是，进程在使用fork函数创建子进程前先创建一个管道，该管道用于在父子进程间通信，然后创建子进程，</span><br>    <span class="hljs-comment">//之后父进程关闭管道的读端，子进程关闭管道的写端。父进程负责向管道写数据而子进程负责读数据。当然父进程可以关闭管道的写端而子进程关闭管道的读端。</span><br>    <span class="hljs-keyword">int</span> pipe_pos= get_pipe_pos(args);<br>        <span class="hljs-keyword">if</span>(pipe_pos!=<span class="hljs-number">-1</span>)<span class="hljs-comment">//has pipes</span><br>        &#123;<br>            <span class="hljs-keyword">pid_t</span> pid;<br>            pid=fork();<br>            <span class="hljs-keyword">if</span>(pid==<span class="hljs-number">0</span>)<span class="hljs-comment">//child process_1</span><br>            &#123;<br>                <span class="hljs-keyword">int</span> fd[<span class="hljs-number">2</span>];<span class="hljs-comment">//管道端口</span><br>                <span class="hljs-keyword">pid_t</span> subpid;<br>				<span class="hljs-comment">//create pipe</span><br>				<span class="hljs-keyword">if</span>(pipe(fd)==<span class="hljs-number">-1</span>)<span class="hljs-comment">//fail to create pipe</span><br>				&#123;<br>						<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;HaHaHa your pipe failed&quot;</span>);<br>						<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>				&#125;<br>				subpid=fork();<br><br>				<span class="hljs-keyword">if</span>(subpid&gt;<span class="hljs-number">0</span>)<span class="hljs-comment">//that is child process_1</span><br>				&#123;<br>                  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=pipe_pos;args[i]!=<span class="hljs-literal">NULL</span>&amp;&amp;i&lt;MAX_LINE/<span class="hljs-number">2</span>+<span class="hljs-number">1</span>;i++)<br>				  &#123;<br>						  <span class="hljs-built_in">free</span>(args[i]);<br>						  args[i]=<span class="hljs-literal">NULL</span>;<br>				  &#125;<span class="hljs-comment">//the params after pipe_pos is useless</span><br>				  close(fd[<span class="hljs-number">0</span>]);<br>				  dup2(fd[<span class="hljs-number">1</span>],STDOUT_FILENO);<br>				  execvp(args[<span class="hljs-number">0</span>],args);<br>				&#125;<br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(subpid==<span class="hljs-number">0</span>)<span class="hljs-comment">//child of childprocess1</span><br>				&#123;<br>				   <span class="hljs-keyword">int</span> num_param=<span class="hljs-number">0</span>;<br>                   <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=pipe_pos;i+<span class="hljs-number">1</span>&lt;MAX_LINE/<span class="hljs-number">2</span>+<span class="hljs-number">1</span>&amp;&amp;args[i+<span class="hljs-number">1</span>]!=<span class="hljs-literal">NULL</span>;i++)<br>				   &#123;<br>						   num_param++;<br>						   <span class="hljs-built_in">strcpy</span>(args[i-pipe_pos],args[i+<span class="hljs-number">1</span>]);<br>				   &#125;<br>				   <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=num_param;i&lt;MAX_LINE/<span class="hljs-number">2</span>+<span class="hljs-number">1</span>&amp;&amp;args[i]!=<span class="hljs-literal">NULL</span>;i++)<br>				   &#123;<br>                     <span class="hljs-built_in">free</span>(args[i]);<br>					 args[i]=<span class="hljs-literal">NULL</span>;<br>				   &#125;<br>				   close(fd[<span class="hljs-number">1</span>]);<br>				   dup2(fd[<span class="hljs-number">0</span>],STDIN_FILENO);<br>				   execvp(args[<span class="hljs-number">0</span>],args);<br>				&#125;<br><br>            &#125;<br>			<span class="hljs-keyword">else</span><span class="hljs-comment">//big father process</span><br>			&#123;<br>					wait(<span class="hljs-literal">NULL</span>);<br>			&#125;<br>        &#125;<br>		<span class="hljs-keyword">else</span> <br>		&#123;<br>            <span class="hljs-keyword">pid_t</span> pid;<br>			pid = fork();<br>			<span class="hljs-keyword">if</span>(pid==<span class="hljs-number">0</span>)<span class="hljs-comment">//child process</span><br>			&#123;<br>			   should_run=<span class="hljs-number">0</span>;<br>               output_redirect(args);<br>			   input_redirect(args);<br>               execvp(args[<span class="hljs-number">0</span>],args);<br><br>			&#125;<br>			<span class="hljs-keyword">else</span><span class="hljs-comment">//parent process</span><br>			&#123;<br>              <span class="hljs-keyword">if</span>(!will_wait)<br>			  &#123;<br>		        wait(<span class="hljs-literal">NULL</span>);<br>			  &#125;<br>			  will_wait=<span class="hljs-number">0</span>;<br>			&#125;<br><br>		&#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><br></code></pre></td></tr></table></figure>

<p>注：这个project还有一个简单的模块编写，就不记载在这里了。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/">计算机科学</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/03/13/%E7%94%A8C%E5%92%8CJava%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E5%A4%9A%E7%BA%BF%E7%A8%8B/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">用C和Java实现简单多线程</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/03/09/Introduction-to-Linux-Kernel-Modeles/">
                        <span class="hidden-mobile">Introduction to Linux Kernel Modeles</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Otsutsuki_Orance</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>humihuadecheng@sjtu.edu.cn</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
